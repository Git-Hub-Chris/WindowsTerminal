<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="15.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Label="Globals">
    <ProjectGuid>{A021EDFF-45C8-4DC2-BEF7-36E1B3B8CFE8}</ProjectGuid>
    <RootNamespace>TestHostApp</RootNamespace>
    <DefaultLanguage>en-US</DefaultLanguage>
    <MinimumVisualStudioVersion>14.0</MinimumVisualStudioVersion>
    <AppContainerApplication>true</AppContainerApplication>
    <ApplicationType>Windows Store</ApplicationType>
    <WindowsTargetPlatformMinVersion>10.0.18362.0</WindowsTargetPlatformMinVersion>
    <WindowsTargetPlatformVersion>10.0.18362.0</WindowsTargetPlatformVersion>
    <ApplicationTypeRevision>10.0</ApplicationTypeRevision>
    <OutputSubDir>Tests\Data</OutputSubDir>
    <UseWmXml>true</UseWmXml>
    <ConfigurationType>Application</ConfigurationType>
    <NoOutputRedirection>true</NoOutputRedirection>
  </PropertyGroup>

  <Import Project="$(SolutionDir)\common.openconsole.props" Condition="'$(OpenConsoleDir)'==''" />

  <Import Project="$(OpenConsoleDir)\src\common.build.pre.props" />

  <!-- This project is _heavily_ cribbed directly from the TAEF samples. In
  order to avoid breaking this project, it's been left largely unmodified. The
  only modifications are those near the bottom of the file:
  * References to our dependent winrt projects (Connection, Settings, Control,
    App)
  * Manual copy steps to copy the actual test code (TerminalApp.LocalTests.dll)
    and the dlls that TerminalConnection is dependent upon, but don't role up
    here for whatever reason.
  -->

  <PropertyGroup Condition="'$(Configuration)'=='Debug'">
    <UseDebugLibraries>true</UseDebugLibraries>
  </PropertyGroup>
  <PropertyGroup Condition="'$(Configuration)'=='Release'">
    <UseDebugLibraries>false</UseDebugLibraries>
    <WholeProgramOptimization>true</WholeProgramOptimization>
    <UseDotNetNativeToolchain>true</UseDotNetNativeToolchain>
  </PropertyGroup>

  <PropertyGroup Label="UserMacros">
    <GenerateAppxPackageOnBuild>false</GenerateAppxPackageOnBuild>
  </PropertyGroup>

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.props" />

  <ImportGroup>
    <Import Project="$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props" Condition="exists('$(UserRootDir)\Microsoft.Cpp.$(Platform).user.props')" />
  </ImportGroup>

  <ItemDefinitionGroup>
    <ClCompile>
      <AdditionalOptions>/bigobj %(AdditionalOptions)</AdditionalOptions>
      <DisableSpecificWarnings>4453;28204;%(DisableSpecificWarnings)</DisableSpecificWarnings>
      <AdditionalIncludeDirectories>%(AdditionalIncludeDirectories)
        ;$(IntermediateOutputPath)
      </AdditionalIncludeDirectories>
      <PreprocessorDefinitions>INLINE_TEST_METHOD_MARKUP;%(PreprocessorDefinitions)</PreprocessorDefinitions>
    </ClCompile>
    <Link>
      <AdditionalDependencies>$(AdditionalDependencies);windowsapp.lib</AdditionalDependencies>
      <IgnoreAllDefaultLibraries>false</IgnoreAllDefaultLibraries>
    </Link>
  </ItemDefinitionGroup>

  <ItemGroup>
    <ClInclude Include="pch.h" />
    <ClInclude Include="UnitTestApp.xaml.h">
      <DependentUpon>UnitTestApp.xaml</DependentUpon>
    </ClInclude>
  </ItemGroup>
  <ItemGroup>
    <ApplicationDefinition Include="UnitTestApp.xaml">
      <SubType>Designer</SubType>
    </ApplicationDefinition>
  </ItemGroup>
  <ItemGroup>
    <AppxManifest Include="Package.appxmanifest">
      <SubType>Designer</SubType>
    </AppxManifest>
  </ItemGroup>
  <ItemGroup>
    <ClCompile Include="UnitTestApp.xaml.cpp">
      <DependentUpon>UnitTestApp.xaml</DependentUpon>
    </ClCompile>
    <ClCompile Include="pch.cpp">
      <PrecompiledHeader>Create</PrecompiledHeader>
    </ClCompile>
  </ItemGroup>

  <!-- Reference all the WinRT projects that we want to role up into this test project. -->
  <ItemGroup>
    <ProjectReference Include="$(OpenConsoleDir)src\cascadia\TerminalSettings\TerminalSettings.vcxproj" />
    <ProjectReference Include="$(OpenConsoleDir)src\cascadia\TerminalControl\TerminalControl.vcxproj" />
    <ProjectReference Include="$(OpenConsoleDir)src\cascadia\TerminalConnection\TerminalConnection.vcxproj" />

    <!-- Don't reference TerminalApp or TerminalAppLib here.
         * If you reference TerminalApp, it'll also try to reference
           TerminalAppLib, and when makepri.exe is eventually called, it'll run
           into a duplicate entry for all the xbfs defined in that project.
         * If you only reference TerminalAppLib here, the AppxManifest.xml will
           think that TerminalAppLib.lib is the hosting binary for all the
           TerminalApp types, which is _bad_

         We'll manually reference the correct dll below.
     -->
  </ItemGroup>

  <PropertyGroup>
    <!-- Some helper paths to find our test code -->
    <_TestBinRoot>$(OpenConsoleDir)\bin\$(Platform)\$(Configuration)</_TestBinRoot>
    <_CppWinrtBinRoot>$(OpenConsoleDir)\$(Platform)\$(Configuration)</_CppWinrtBinRoot>
    <_CppWinrtBinRoot Condition="'$(Platform)'=='Win32'">$(OpenConsoleDir)\$(Configuration)</_CppWinrtBinRoot>
    <_TAEFPlatformName>$(Platform)</_TAEFPlatformName>
    <_TAEFPlatformName Condition="'$(Platform)'=='Win32'">x86</_TAEFPlatformName>
  </PropertyGroup>

  <ItemGroup>
    <Reference Include="Microsoft.VisualStudio.TestPlatform.TestExecutor.WinRTCore">
      <HintPath>$(OpenConsoleDir)\packages\Taef.Redist.Wlk.10.48.200103003-develop\lib\Microsoft.VisualStudio.TestPlatform.TestExecutor.WinRTCore.winmd</HintPath>
      <IsWinMDFile>true</IsWinMDFile>

      <!-- This path is _relative to the .winmd_ -->
      <Implementation>..\build\Binaries\$(_TAEFPlatformName)\TE.AppxUnitTestClient.dll</Implementation>
    </Reference>
  </ItemGroup>


  <ItemGroup>
    <!-- Manually reference TerminalApp -->
    <Reference Include="TerminalApp">
      <HintPath>$(_CppWinrtBinRoot)\TerminalApp\TerminalApp.winmd</HintPath>
      <IsWinMDFile>true</IsWinMDFile>
      <Implementation>TerminalApp.dll</Implementation>
    </Reference>
  </ItemGroup>

  <Import Project="$(OpenConsoleDir)\packages\Microsoft.UI.Xaml.2.3.191217003-prerelease\build\native\Microsoft.UI.Xaml.targets" Condition="Exists('$(OpenConsoleDir)\packages\Microsoft.UI.Xaml.2.3.191217003-prerelease\build\native\Microsoft.UI.Xaml.targets')" />

  <Import Project="$(VCTargetsPath)\Microsoft.Cpp.targets" />


  <Target Name="AfterBuild">

    <!-- Copy the AppxManifest.xml to another file, because when TAEF is
      deploying the app, it'll delete the AppxManifest.xml file from this
      directory when it tries to clean up after itself. -->
    <Copy SourceFiles="$(TargetDir)\AppxManifest.xml" DestinationFiles="$(TargetDir)\TestHostAppXManifest.xml" />

    <!-- Copy our test code from LocalTests_TerminalApp into this directory -->
    <Copy SourceFiles="$(_TestBinRoot)\LocalTests_TerminalApp\TerminalApp.LocalTests.dll" DestinationFiles="$(TargetDir)\TerminalApp.LocalTests.dll" />

    <!-- Copy some dlls which TerminalConnection is dependent upon that didn't
      get rolled up into this  directory -->

    <Copy SourceFiles="$(_CppWinrtBinRoot)\TerminalConnection\cpprest142_2_10d.dll" DestinationFiles="$(TargetDir)\cpprest142_2_10d.dll" />
    <Copy SourceFiles="$(_CppWinrtBinRoot)\TerminalConnection\telnetpp.dll" DestinationFiles="$(TargetDir)\telnetpp.dll" />

  </Target>
</Project>
