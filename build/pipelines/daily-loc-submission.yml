trigger: none
pr: none
schedules:
  - cron: "0 3 * * 2-6" # Run at 03:00 UTC Tuesday through Saturday (After the work day in Pacific, Mon-Fri)
    displayName: "Nightly Localization Build"
    branches:
      include:
        - main
    always: false # only run if there's code changes!

pool:
  vmImage: windows-2019

resources:
  repositories:
  - repository: self
    type: git
    ref: main
  - repository: internal
    type: git
    name: Terminal.Internal
    ref: main

steps:

- checkout: self
  clean: true
  submodules: false
  fetchDepth: 1 # Don't need a deep checkout for loc files!
  fetchTags: false # Tags still result in depth > 1 fetch; we don't need them here
  persistCredentials: true
  path: s # Adding a second repo made Azure DevOps change where we're checked out.

- checkout: internal
  clean: true
  submodules: false
  fetchDepth: 1
  persistCredentials: true
  path: s/Terminal.Internal

- task: MicrosoftTDBuild.tdbuild-task.tdbuild-task.TouchdownBuildTask@1
  displayName: 'Touchdown Build - 7105, PRODEXT'
  inputs:
    teamId: 7105
    authId: '$(TouchdownApplicationID)'
    authKey: '$(TouchdownApplicationKey)'
    resourceFilePath: |
     **\en-US\*.resw
     Terminal.Internal\PDPs\Stable\PDPs\en-us\PDP.xml
     Terminal.Internal\PDPs\Preview\PDPs\en-us\PDP.xml
    outputDirectoryRoot: LocOutput
    appendRelativeDir: true
    pseudoSetting: Included
    localizationTarget: false

- pwsh: >-
    Remove-Item -EA:Ignore -R -Force LocOutput\Terminal.Internal

    $Files = Get-ChildItem LocOutput -R -Include 'ContextMenu.resw','Resources.resw' | ? FullName -Like '*en-US\*\*.resw'

    $Files | % { Move-Item -Verbose $_.Directory $_.Directory.Parent.Parent -EA:Ignore }

    Get-ChildItem LocOutput -R -Filter '*.resw' | % {

      ((Get-Content $_.FullName) -join "`r`n") + "`r`n" | Set-Content -NoNewline $_.FullName

    }

    & tar.exe -c -f LocOutputMunged.tar -C LocOutput

    & tar.exe -x -v -f LocOutputMunged.tar

    rm LocOutputMunged.tar

    rm -r -fo LocOutput

    & ./build/scripts/Copy-ContextMenuResourcesToCascadiaPackage.ps1

    git config --local user.email "consvc@microsoft.com"

    git config --local user.name "Console Service Bot"

    git add **/*.resw

    git status

    git switch -c loc-update

    $Now = Get-Date

    git commit -m "Localization Updates - $Now"

    git push origin HEAD:refs/heads/loc-update -f
  displayName: Move Loc files to the right places and commit them I guess?
